
<!DOCTYPE html>
<html id="html">
<head>
<meta name="viewport" content="width=1200">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Pragma" content="No-cache" />
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
<meta http-equiv="Expires" content="-1" />
<link rel=stylesheet type="text/css" href="css/jquery.selectbox.css" media="all" />
<link href="css/stylish-select.css" type="text/css" rel="stylesheet" />
<link href="css/style_page.css" type="text/css" rel="stylesheet" />
<title></title>
<script type="text/javascript" charset="utf-8" src="js/localization/zh-cn.js"></script>
<script type="text/javascript" charset="utf-8" src="js/header.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery.selectbox-0.2_new.js"></script>
<script type="text/javascript" charset="utf-8" src="js/SOAP/SOAPAction.js"></script>
<script type="text/javascript" charset="utf-8" src="js/initialJS.js"></script>
<script type="text/javascript" charset="utf-8" src="js/AdvWlanAccess.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/SOAP/SOAPUpnp.js"></script>
<script type="text/javascript">
//xframeoption
if(top!=self){top.location=self.location;}

var G_List = [];
//var HNAP = new HNAP_XML();

$(document).ready( function() {
	document.getElementById("right_content").style.display="none";
	document.getElementById("CreateOnloadMessage").style.display="";
	MoreContainMiniheight();	
	GetXML();
	checkTimeout();
});

	function GetXML()	
	{	
		GetResult_1st();
	}
	function GetResult_1st()
	{
		var soapAction = new SOAPAction();
		var sOAPGetUpnpResponse = new SOAPGetUpnpResponse();
		//获取用户列表
		var clientInfo = soapAction.sendSOAPAction("GetUpnpSettings", null, sOAPGetUpnpResponse);
		$.when(clientInfo).done(function(obj){
			GetResult_2nd(obj);
		})
				.fail(function(){
					document.getElementById("right_content").style.display="";
					document.getElementById("CreateOnloadMessage").style.display="none";
					if (DebugMode == 1)	{
						alert("[!!GetXML Error!!] Function: GetResult_1st");
					}
				});

		/*var result_xml = new StringDoc();
		if (result_xml != null)
		{
			result_xml.Set("GetUpnpSettings");
			HNAP.SetXMLAsync("GetUpnpSettings", result_xml, function(xml)	{	GetResult_2nd(xml);	});
		}
		else	{	if (DebugMode == 1)	{	alert("[!!GetXML Error!!] Function: GetResult_1st");	}	}
	*/
	}
	
	function GetResult_2nd(UpnpClientInfo)
	{

		var upnpenable=UpnpClientInfo.Enable;
		if(upnpenable=="true")
		{
			document.getElementById("upnp_enable").checked = true;
			document.getElementById("upnp_statue").className = "checkbox_on";
			document.getElementById("upnpcontent").style.display="";
		}
		else
		{
			document.getElementById("upnp_enable").checked = false;
			document.getElementById("upnp_statue").className = "checkbox_off";
			document.getElementById("upnpcontent").style.display="none";
		}
		for(var i = 0;i<UpnpClientInfo.UpnpClientInfoLists.ClientInfo.length;i++){
			var dhcplist = [];
			dhcplist[0]=UpnpClientInfo.UpnpClientInfoLists.ClientInfo[i].Protocol;
			dhcplist[1]=UpnpClientInfo.UpnpClientInfoLists.ClientInfo[i].ApplicationName;
			dhcplist[2]=UpnpClientInfo.UpnpClientInfoLists.ClientInfo[i].ClientIP;
			dhcplist[3]=UpnpClientInfo.UpnpClientInfoLists.ClientInfo[i].InternalPort;
			dhcplist[4]=UpnpClientInfo.UpnpClientInfoLists.ClientInfo[i].ExternalPort;
			G_List.push(dhcplist);
		}

		CreateBindTable();

		document.getElementById("right_content").style.display="";
		document.getElementById("CreateOnloadMessage").style.display="none";
		/*var GetResult_2nd = result_xml.Get("GetUpnpSettingsResponse/GetUpnpSettingsResult");
		if (GetResult_2nd == "OK"){
	
			var ruleinfo= result_xml.Get("GetUpnpSettingsResponse/upnp_rule");
			var upnpenable=result_xml.Get("GetUpnpSettingsResponse/upnp_enable");

			if(upnpenable=="1")
			{
				document.getElementById("upnp_enable").checked = true;
				document.getElementById("upnp_statue").className = "checkbox_on";
				document.getElementById("upnpcontent").style.display="";
			}
			else
			{
				document.getElementById("upnp_enable").checked = false;
				document.getElementById("upnp_statue").className = "checkbox_off";
				document.getElementById("upnpcontent").style.display="none";		
			}
					
			var rulelist=[];
			var ruletem=[];
			if(ruleinfo.length>0)
			{
				ruletem=ruleinfo.split(";");
			}
			for(var i=0;i<ruletem.length;i++)
			{
				G_List.push(ruletem[i].split(","));	
			}
			
			CreateBindTable();
			
			document.getElementById("right_content").style.display="";
			document.getElementById("CreateOnloadMessage").style.display="none";
			
		} else {	
		
			document.getElementById("right_content").style.display="";
			document.getElementById("CreateOnloadMessage").style.display="none";
			if (DebugMode == 1)	{	
				alert("[!!GetXML Error!!] Function: GetResult_2nd");
			}
		}*/
	}
	
function CreateBindTable()
{
	if(G_List.length>0)
	{
		document.getElementById("trnull").style.display="none";
	}
	else
	{
		document.getElementById("trnull").style.display="";
	}
	ClearTable("upnplist",3);
	var TableList=[];
	for(var i=0;i<G_List.length;i++)
	{
		TableList[i]=[];
		TableList[i].push(G_List[i][0]);
		TableList[i].push(G_List[i][1]);
		TableList[i].push(G_List[i][2]);
		TableList[i].push(G_List[i][3]);
		TableList[i].push(G_List[i][4]);
	}
	CreateTable("upnplist", TableList);
}


function ChangUpnpStatus()
{ 
	var a = document.getElementById("upnp_enable").checked;
	
	if(a)
	{
		document.getElementById("upnp_statue").className = "checkbox_off";
		document.getElementById("upnp_enable").checked=false;
		document.getElementById("upnpcontent").style.display="none";

	}
	else
	{
		document.getElementById("upnp_statue").className = "checkbox_on";
		document.getElementById("upnp_enable").checked=true;
		document.getElementById("upnpcontent").style.display="";
	}
	$.ajax({
			cache: false,
			url: "./js/CheckConnection",
			timeout: 5000,
			type: "GET",
			success: function(data) {
				SetXML();
			},
			error: function() {
				document.getElementById("DetectRouterConnection").style.display = "inline";
			}
		});		
}

function SetXML() {
	document.getElementById("CreatePopAlertMessage").style.display = "inline";
	document.getElementById("waitSettingFinish").style.display = "inline";
	SetResult_1st();
}

function SetResult_1st() {
	var soapAction = new SOAPAction();
	var sOAPSetUpnpResponse = new SOAPSetUpnpResponse();
	sOAPSetUpnpResponse.Enable=document.getElementById("upnp_enable").checked==true?"true":"false";
	soapAction.sendSOAPAction("SetUpnpSettings",sOAPSetUpnpResponse,null)
			.done(function(obj2)
			{
				//for compatibility
				if(obj2.SetUpnpSettingsResult != "OK")
				{
					if (DebugMode == 1) {
						alert("[!!SetXML Error!!] Function: SetResult_1st");
					}
					document.getElementById("CreatePopAlertMessage").style.display = "none";
					document.getElementById("waitSettingFinish").style.display = "none";
					document.getElementById("DetectRouterConnection").style.display = "inline";
				}else
				{
					//setTimeout("waitSettingFinished()", 1000);
					waitSettingFinished();
				}
			})
			.fail(function(){
				if (DebugMode == 1)	{
					alert("[!!SetXML Error!!] Function: SetResult_1st");
				}
				document.getElementById("CreatePopAlertMessage").style.display = "none";
				document.getElementById("waitSettingFinish").style.display = "none";
				document.getElementById("DetectRouterConnection").style.display = "inline";
			});


	/*var result_xml = new StringDoc();
	if (result_xml != null) {
		
		result_xml.Set("SetUpnpSettings/upnp_enable", document.getElementById("upnp_enable").checked==true?"1":"0");
		HNAP.SetXMLAsync("SetUpnpSettings", result_xml, function(xml)	{	SetResult_2nd(xml);	});
	} else {	
		if (DebugMode == 1)	{	
			alert("[!!SetXML Error!!] Function: SetResult_1st");	
		}	
	}*/
}

/*function SetResult_2nd(result_xml) {
	var SetResult_1st = result_xml.Get("SetUpnpSettingsResponse/SetUpnpSettingsResult");
	if (SetResult_1st == "OK") {
		setTimeout("waitSettingFinished()", 1000);
	}
	if (SetResult_1st == "ERROR") {
		if (DebugMode == 1) {
		alert("[!!SetXML Error!!] Function: SetResult_2nd");
		}
		window.location.reload();
	}
}*/
function waitSettingFinished() 
{
	window.location.reload();
}	

</script>
</head>

<body>
<!-------------------- Logo menu------------------------->
	<div class="wrapper">  
		<div id="header"></div>
		<div class="clearboth" align="center" id="content">
			<div class="morecontent" align="center" id="basiccontent">
		 		<div class="pull-left" id="sub_menu_container"> 
				<script>initialLeftMenu();</script>
				</div>
				<div id="right_content"  class="pull-left" style="display:none; ">
					<table border="0"  class="clearboth tablemoreheader" cellpadding="0" cellspacing="0" align="left">
						<tr>
							<th><script>I18N("h","UPnP_Enable");</script><!-- 开启UPnP --></th>
							<td class="tdcheckbox">
								 <div id="upnp_statue" class="checkbox_off" onclick="ChangUpnpStatus()">
                       				 <input type="checkbox" id="upnp_enable" name="upnp_enable">
                      			</div>
							</td>						
							</tr>
					</table>
					<div class="clearboth moreline1"></div>
					<div id="upnpcontent" style="display:none; ">
					<div class="moredescription" style="text-align:justify;"><script>I18N("h","UPnP_Description");</script><!-- 开启 UPnP （Universal Plug and Play，通用即插即用）功能后，局域网中的计算机可以请求路由器自动进行端口转换。这样，互联网上的计算机就能在需要时访问局域网计算机上的资源（如 MSN Messenger 或迅雷、BT、PPTV 等支持 UPnP 协议的应用程序），让您在观看在线视频或使用多点下载等方面的软件时，享受更加稳定的网络。 --></div>		
		  			<table class="table_list" id="upnplist" align="left" cellpadding="0" cellspacing="0" style="margin-top:64px; ">
					<tbody>
					<tr class="tableheader">
						<td colspan="5">
						<div><div style="text-align:center;"><script>I18N("h","UPnP_Port_Map");</script><!-- UPnP端口映射 --></div></div>
						</td>
					</tr>
					<tr class="tableheader2">
						<td style="width:142px; "><script>I18N("h","UPnP_Protocol");</script><!-- 协议 --></td>
						<td style="width:198px;; "><script>I18N("h","UPnP_Application_Name");</script><!-- 应用名称 --></td>
						<td style="width:198px; "><script>I18N("h","UPnP_Client_IP");</script><!-- 客户端IP --></td>
						<td style="width:115px; "><script>I18N("h","Commom_Internal_Port");</script><!-- 内部端口 --></td>
						<td style="width:115px; "><script>I18N("h","Commom_External_Port");</script><!-- 外部端口 --></td>
					</tr>
					<tr id="trnull">
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					</tr>
				
				
				</tbody>
			
			
			</table>					 
			</div>
				</div><!--end right_content -->
			</div>
	   </div>
 	   <div class="footer_placeholder"></div>  
   </div>

	
	<div id="footer"></div>

	<div id="CreatePopAlertMessage" style=" display:none;"></div>
	<div style=" display:none;" id="DetectRouterConnection"></div>
	<div id="CreateOnloadMessage" style="display:none;"><div class="OnLoadPopRect"><img src="image/submit.gif" width="58" height="58"></div></div>
</body>
<script type="text/javascript">
Initial();
</script>
</html>
