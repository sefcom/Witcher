
<!DOCTYPE html>
<html id="html">
<head>
<meta name="viewport" content="width=1200">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Pragma" content="No-cache" />
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
<meta http-equiv="Expires" content="-1" />
<link rel=stylesheet type="text/css" href="css/jquery.selectbox.css" media="all" />
<link href="css/stylish-select.css" type="text/css" rel="stylesheet" />
<link href="css/style_page.css" type="text/css" rel="stylesheet" />
<title></title>
<script type="text/javascript" charset="utf-8" src="js/localization/zh-cn.js"></script>
<script type="text/javascript" charset="utf-8" src="js/header.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery.selectbox-0.2_new.js"></script>
<script type="text/javascript" charset="utf-8" src="js/SOAP/SOAPAction.js"></script>
<script type="text/javascript" charset="utf-8" src="js/initialJS.js"></script>
<script type="text/javascript" charset="utf-8" src="js/upload.js"></script>
<script type="text/javascript">
//xframeoption
if(top!=self){top.location=self.location;}


//var HNAP = new HNAP_XML();
var file_name="";
var minsize = 1*1024;	  //1K
var maxsize = 1*1024*1024;//1M
var timer = 70;
var domain_name = "Index.html";

$(document).ready( function() {
   MoreContainMiniheight();
	checkTimeout();
	document.getElementById("btn_begin_upload").value = I18N("j","Backup_Begin_Upload");//开始导入
	document.getElementById("btn_fail_confirm").value = I18N("j","Commom_Confirm");//确认
	document.getElementById("savebutton5").value = I18N("j","Backup_Save_File");//保存文件
	document.getElementById("btn_upload_calcel").value = I18N("j","Commom_Cancel");//取消
	document.getElementById("btn_upload_confirm").value = I18N("j","Commom_Confirm");//确认
	if(G_Language == "en-us")
	{
		$(".dialogBoxBackup").css("height","385px");
	}
	
});

function Body_Onload()
{
	if (COMM_GetURLParameter("UpdateResult") != "")
	{
		switch(COMM_GetURLParameter("UpdateResult"))
		{
			case "SUCCESS":
				document.getElementById("createPop_RecoveryState").style.display = "inline";
				GetDomainName_1st();
				setTimeout("Start_ConfigRecovery()", 1000);
				break;
			default:
				document.getElementById("createPop_RecoveryFail").style.display = "inline";
				break;
		}
	}
}

function Device_Reboot()
{
	//提交重启请求
	var soapAction = new SOAPAction();
	soapAction.sendSOAPAction("RunReboot", null, null);
	/*var result_xml = new StringDoc();
	if (result_xml != null) {
		// Send HNAP to DUT
		HNAP.SetXMLAsync("SetRebootSettings", result_xml, function(xml)	{;});
	}*/
}

function GetDomainName_1st()
{

	var soapAction = new SOAPAction();
	//domainName
	var domainName = soapAction.sendSOAPAction("GetDeviceDomainName", null, new function(){this.DomainName=""});
	$.when(domainName)
			.done(function(r1){
				GetDomainName_2nd(r1);
			})
			.fail(function(){
				if (DebugMode == 1)	{
					alert("[!!GetXML Error!!] Function: GetResult_1nd");
				}
			});
	/*var result_xml = new StringDoc();
	if (result_xml != null)
	{
		result_xml.Set("GetDeviceDomainName");
		HNAP.SetXMLAsync("GetDeviceDomainName", result_xml, function(xml)	{	GetDomainName_2nd(xml);	});
	}
	else	{	if (DebugMode == 1)	{	alert("[!!GetXML Error!!] Function: GetResult_1st");	}	}*/
}
	
function GetDomainName_2nd(domainName)
{
	domain_name = domainName.DomainName;
	Device_Reboot();
	/*var GetResult_2nd = result_xml.Get("GetDeviceDomainNameResponse/GetDeviceDomainNameResult");
	if (GetResult_2nd == "OK"){
		domain_name = result_xml.Get("GetDeviceDomainNameResponse/device_domain_name");
		Device_Reboot();
	}
	else	{	if (DebugMode == 1)	{	alert("[!!GetXML Error!!] Function: GetResult_1st");	}	}*/
}

function redirectPage()
{
	//window.location.href = "Index.html";
	window.location.href = "http://" + domain_name;
}

function Start_ConfigRecovery()
{
	timer--;
	//document.getElementById("remaining_time").innerHTML = timer + "秒";
	document.getElementById("remaining_time").innerHTML = timer + I18N("j","Home_Second");
	if(timer <= 0)
	{
		document.getElementById("ConfigRecoverDone").style.display = "";
		document.getElementById("ConfigRecovering").style.display = "none";
		setTimeout("redirectPage()", 3000);
		return false;
	}
	setTimeout("Start_ConfigRecovery()", 1000);
}

function ShowChooseFileName(obj)
{
	$("#error_backup").hide();
	file_name=obj.value.substr(obj.value.lastIndexOf('\\') + 1);
	if(""==file_name)
	{
		document.getElementById("filename_display").innerHTML = "";
		document.getElementById("filename_display").style.display = "none";
		document.getElementById("begin_upload").style.display = "none";
		$("#uploadConfigFile").replaceWith('<input type="file" id="uploadConfigFile" name="uploadConfigFile" class="uploadConfigFile" onfocus="this.blur()" onchange="ShowChooseFileName(this);">');
	}
	else
	{
		document.getElementById("filename_display").innerHTML = file_name;
		document.getElementById("filename_display").style.display = "";
		document.getElementById("begin_upload").style.display = "";
	}
	
}
function BeginUploadFile()
{
	var file_type=file_name.substring(file_name.lastIndexOf(".")+1).toLowerCase();
	if("dat"!=file_type)//文件类型判断
	{
		$("#filename_display").hide();
		showErr("error_backup","errorinfo_backup",I18N("j","Err_Backup_fileType"));
		return false;
	}
	
	try
	{
		var file_size=$("#uploadConfigFile")[0].files[0].size;
		if(file_size<minsize)
		{
			$("#filename_display").hide();
			showErr("error_backup","errorinfo_backup",I18N("j","Err_Backup_fileMinSize"));
			return false;
		}
		else if(file_size>maxsize)
		{
			$("#filename_display").hide();
			showErr("error_backup","errorinfo_backup",I18N("j","Err_Backup_fileMaxSize"));
			return false;
		}
	}
	catch(e)
	{
		//alert(e.message);
		//return false;
	}
	
	document.getElementById("createPop_UploadFile").style.display = "";
}

function UploadFileConfirm()//上传文件确认
{
	document.forms["upload_form"].submit();
}
function UploadFileCancle()//上传文件取消
{
	document.getElementById("createPop_UploadFile").style.display = "none";
	document.getElementById("filename_display").innerHTML="";
	document.getElementById("begin_upload").style.display = "none";
	$("#uploadConfigFile").replaceWith('<input type="file" id="uploadConfigFile" name="uploadConfigFile" class="uploadConfigFile" onfocus="this.blur()" onchange="ShowChooseFileName(this);">');
}
function upload_recovery_fail()
{
	document.getElementById("createPop_RecoveryFail").style.display = "none";
	window.location.href = "Backup.html";
}
</script>
</head>

<body onload="Body_Onload()">
<!-------------------- Logo menu------------------------->
	<div class="wrapper">  
		<div id="header"></div>
		<div class="clearboth" align="center" id="content">
			<div class="morecontent" align="center" id="basiccontent">
		 		<div class="pull-left" id="sub_menu_container"> <script>initialLeftMenu();</script></div>
				<div id="right_content"  class="pull-left">
					<table border="0" align="left" class="clearboth tablemoreheader" cellpadding="0" cellspacing="0">
						<tr>
							<th><script>I18N("h","Backup_Headline");</script><!-- 备份与恢复 --></th>
						</tr>
					</table>
					<div class="clearboth moreline1"></div>
					<div class="description" style="text-align:justify;"><script>I18N("h","Backup_Description");</script><!-- 通过备份功能，您可以将当前路由的配置导出备份到计算机中。当路由的配置信息被修改后，通过恢复配置导入之前备份的配置信息，可快速恢复到之前的配置。 --></div>
					<div class="clearboth headerline2" align="left" style="padding-top:64px;margin-bottom:12px;">
						<script>I18N("h","Backup_Config");</script><!-- 备份配置 -->
					</div>
					<div class="moreline1"></div>
					<div class="description"><script>I18N("h","Backup_Config_Description");</script><!-- 可以备份路由器的当前配置 --></div>
			   		<form id="dlcfgbin" action="cgi-bin/ExportSettings.sh" method="post">
						<input type="hidden" value="Export" name="Export">
					 <div align="left">
						<!-- <input type="button" value="保存文件" id="savebutton5" class="styled_button_s" style="margin-top:24px;" onClick="document.forms['dlcfgbin'].submit();"> -->
						<input type="button" value="" id="savebutton5" class="styled_button_ss" style="margin-top:24px;" onClick="document.forms['dlcfgbin'].submit();">
					 </div>
			 		</form>
					<div  class="clearboth headerline2" align="left" style="padding-top:64px;margin-bottom:12px;">
						<script>I18N("h","Backup_Recovery_Config");</script><!-- 恢复配置 -->
					</div>
					<div class="moreline1"></div>
					<!-- <div class="description" style="display:none; ">提示：恢复配置过程中请勿断电！</div> -->
					<div align="left" style="margin-top:24px;">
				 		<form action="/cgi-bin/upload_settings.cgi" method="post" id="upload_form" enctype="multipart/form-data" style="margin-top:24px;">
							<div>
								<label for="uploadConfigFile" class="styled_button_ss" style="z-index:10;line-height: 46px;"><script>I18N("h","Backup_Choose_File");</script><!-- 选择文件 --></label>
							</div>
							<div style="width:280px;overflow:hidden;position:relative;">
								<input type="file" id="uploadConfigFile" name="uploadConfigFile" class="uploadConfigFile" onfocus="this.blur()" onchange="ShowChooseFileName(this);">
							</div>
						</form>
					</div>
					<div id="filename_display" class="clearboth description" align="left" style="padding-top:36px;"></div>
					<div align="left" id="error_backup" style="margin-top:36px;display:none;">
						<table>
							<tbody>
								<tr>
									<td>
									<div class="ic-sign ic" style="padding:0"></div>
								  </td>
								  <td id="errorinfo_backup" class="clearboth description" style="padding:0"></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div align="left" id="begin_upload" style="margin-top:36px;display:none;">
						<!-- <input type="button" value="开始导入" class="styled_button_s" onClick="BeginUploadFile();"> -->
						<input type="button" id="btn_begin_upload" value="" class="styled_button_ss" onClick="BeginUploadFile();">
					</div>
				</div><!--end right_content -->
			</div>
	   </div>
 	   <div class="footer_placeholder"></div>  
   </div>
   	<div style="display: none" id="createPop_UploadFile" class="createPopRecovery">
		<div class="dialogBoxBackup">
			<div class="advance_rowBackup">
				<span><script>I18N("h","Backup_Upload_File");</script><!-- 导入配置文件 --></span>
			</div>
			<div class="descriptionBackup"><span><script>I18N("h","Backup_Recovery_Confirm");</script><!-- 您确认要恢复配置文件吗？这可能会导致当前设置丢失。 --></span></div>
			<div class="advance_rowBackup" style="margin:0px"></div>
			<div align="center" style="margin-bottom:43px;margin-top:24px">
				<!-- <input type="button" value="确认" class="styled_button_ss" style="margin-left:45px;" onClick="UploadFileConfirm();">
				<input type="button" value="取消" class="styled_button_ss" style="margin-left:18px;margin-right:45px;" onClick="UploadFileCancle();"> -->
				<input type="button" id="btn_upload_calcel" value="" class="styled_button_ss"  onClick="UploadFileCancle();">
				<input type="button" id="btn_upload_confirm" value="" class="styled_button_ss"  onClick="UploadFileConfirm();">
			</div>
		</div>
	</div>
	
	<div style=" display:none;" id="createPop_RecoveryFail" class="createPopRecovery">
		<div class="dialogBoxBackup">
			<div class="advance_rowBackup">
				<span><script>I18N("h","Backup_Upload_File");</script><!-- 导入配置文件 --></span>
			</div>
			<div align="center" style="margin-bottom:34px;margin-top:36px">
				<img src="image/icon_peizhi_sb-.png" class="Backup_img">
				<div class="descriptionBackup" style="margin-bottom:34px;margin-top:26px"><script>I18N("h","Backup_Recovery_Fail");</script><!-- 恢复配置文件失败 --></div>
			</div>
			<div class="advance_rowBackup" style="padding-bottom:0px;margin:0"></div>
			<div align="center" style="margin-top:26px;">
				<!-- <input type="button" value="确认" style="width:280px" class="styled_button_ss" onClick="upload_recovery_fail();"> -->
				<input type="button" id="btn_fail_confirm" value=""  class="styled_button_ss" onClick="upload_recovery_fail();">
			</div>
		</div>
	</div>
	
	<div style="display:none;" id="createPop_RecoveryState" class="createPopRecovery">
		<div class="dialogBoxBackup">
			<div id="ConfigRecovering" align="center">
				<div class="advance_rowBackup">
					<span><script>I18N("h","Backup_Upload_File");</script><!-- 导入配置文件 --></span>
				</div>
				<div style="margin-top:50px;">
				<img src="image/submit.gif" style="height:58px;width:58px;"/>
				<div class="remaining_time" id="remaining_time">70<script>I18N("h","Backup_Second");</script><!-- 秒 --></div>
				<div class="descriptionBackup" style="margin:26px 0px;"><script>I18N("h","Backup_Recovering");</script><!-- 请勿断电，正在为您恢复配置文件，请稍候··· --></div>
				</div>
			</div>
			<div id="ConfigRecoverDone" align="center" style="margin-top:108px;display:none">
				<img src="image/icon_peizhi_cg.png" class="Backup_img"/>
				<div class="descriptionBackup" style="margin:28px 0px;"><script>I18N("h","Backup_Recovery_Success");</script><!-- 恢复配置文件成功 --></div>
			</div>
		</div>
	</div>
	<div id="footer"></div>

	<div id="CreatePopAlertMessage" style=" display:none;"></div>
	<div style=" display:none;" id="DetectRouterConnection"></div>
</body>
<script type="text/javascript">
Initial();
</script>
</html>
