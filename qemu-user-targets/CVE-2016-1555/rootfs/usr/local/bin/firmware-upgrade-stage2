#!/bin/sh

if [ -z $1 ]; then
	logger -s "$0 [netboot]"
	exit 1
fi

BOOT_TYPE=$1

sync

if [ $BOOT_TYPE == "flashboot" ]; then
	echo "*** Unmounting existing file systems"
	/bin/umount /oldroot/dev/pts
	/bin/umount /oldroot/proc
	/bin/umount /oldroot/etc
	/bin/umount /oldroot/var
	/bin/umount -l /oldroot/
fi

echo "*** Erasing / Copying kernel image to flash (/dev/mtd2)"
flashcp vmlinux.lzma.uImage /dev/mtd2
if [ $? -ne 0 ];
then
        logger -s "ERROR: failed to copy kernel image"
        rm -f vmlinux.lzma.uImage rootfs.squashfs
        /usr/bin/panel_led 4
        exit 3
fi

echo "*** Erasing / Copying rootfs image to flash (/dev/mtd3)"
flashcp rootfs.squashfs /dev/mtd3
if [ $? -ne 0 ];
then
        logger -s "ERROR: failed to copy rootfs image"
        rm -f rootfs.squashfs
        /usr/bin/panel_led 4
        exit 4
fi

reboot -n -f
